<div class="users-page">
  <!-- Page Header -->
  <div class="page-header">
    <h1>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h1>
    <p>Qu·∫£n l√Ω th√¥ng tin ng∆∞·ªùi d√πng trong h·ªá th·ªëng</p>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="search-bar">
      <div class="search-input">
        <input 
          type="text" 
          [(ngModel)]="searchKeyword" 
          placeholder="T√¨m ki·∫øm theo email, username, s·ªë ƒëi·ªán tho·∫°i..."
          (keyup.enter)="onSearch()"
        />
      </div>
      <button class="btn btn-primary" (click)="onSearch()">
        üîç T√¨m ki·∫øm
      </button>
      <button class="btn btn-secondary" (click)="searchKeyword = ''; onSearch()">
        ‚úñ X√≥a
      </button>
    </div>

    <div class="filters">
      <label>Hi·ªÉn th·ªã:</label>
      <select [(ngModel)]="pageSize" (change)="onPageSizeChange()">
        <option [value]="10">10 m·ª•c</option>
        <option [value]="20">20 m·ª•c</option>
        <option [value]="50">50 m·ª•c</option>
        <option [value]="100">100 m·ª•c</option>
      </select>
    </div>
  </div>

  <!-- Users Table -->
  <div class="users-table-container">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th (click)="onSort('username')">
              Username
              <span class="sort-icon">{{ sortBy === 'username' ? (sortDirection === SortDirection.Ascending ? '‚ñ≤' : '‚ñº') : '‚¨ç' }}</span>
            </th>
            <th (click)="onSort('email')">
              Email
              <span class="sort-icon">{{ sortBy === 'email' ? (sortDirection === SortDirection.Ascending ? '‚ñ≤' : '‚ñº') : '‚¨ç' }}</span>
            </th>
            <th>H·ªç t√™n</th>
            <th>S·ªë ƒëi·ªán tho·∫°i</th>
            <th (click)="onSort('status')">
              Tr·∫°ng th√°i
              <span class="sort-icon">{{ sortBy === 'status' ? (sortDirection === SortDirection.Ascending ? '‚ñ≤' : '‚ñº') : '‚¨ç' }}</span>
            </th>
            <th>Email x√°c th·ª±c</th>
            <th (click)="onSort('createdAt')">
              Ng√†y t·∫°o
              <span class="sort-icon">{{ sortBy === 'createdAt' ? (sortDirection === SortDirection.Ascending ? '‚ñ≤' : '‚ñº') : '‚¨ç' }}</span>
            </th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users">
            <td>{{ user.username }}</td>
            <td class="email">{{ user.email }}</td>
            <td>{{ (user.firstName || '') + ' ' + (user.lastName || '') || 'N/A' }}</td>
            <td>{{ user.phoneNumber || 'N/A' }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(user.status)">
                {{ getStatusLabel(user.status) }}
              </span>
            </td>
            <td>
              <span class="verified-badge" [ngClass]="user.emailVerified ? 'verified' : 'unverified'">
                {{ user.emailVerified ? '‚úì ƒê√£ x√°c th·ª±c' : '‚úó Ch∆∞a x√°c th·ª±c' }}
              </span>
            </td>
            <td>{{ formatDate(user.createdAt) }}</td>
            <td>
              <div class="actions">
                <button class="btn-view" (click)="viewUserDetail(user.userId!)" title="Xem chi ti·∫øt">
                  üëÅÔ∏è
                </button>
                <button class="btn-edit" (click)="openEditModal(user)" title="Ch·ªânh s·ª≠a">
                  ‚úèÔ∏è
                </button>
                <button class="btn-delete" (click)="openDeleteModal(user)" title="X√≥a">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>

          <!-- Empty State -->
          <tr *ngIf="!isLoading && users.length === 0">
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <h3>Kh√¥ng c√≥ d·ªØ li·ªáu</h3>
                <p>Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o ph√π h·ª£p v·ªõi t√¨m ki·∫øm c·ªßa b·∫°n.</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="users.length > 0">
      <div class="pagination-info">
        Hi·ªÉn th·ªã {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, totalRecords) }} 
        trong t·ªïng s·ªë {{ totalRecords }} b·∫£n ghi
      </div>
      <div class="pagination-controls">
        <button (click)="onPageChange(1)" [disabled]="currentPage === 1">
          ‚ü™
        </button>
        <button (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">
          ‚Äπ
        </button>
        <button 
          *ngFor="let page of getPageNumbers()" 
          [class.active]="page === currentPage"
          (click)="onPageChange(page)"
        >
          {{ page }}
        </button>
        <button (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages">
          ‚Ä∫
        </button>
        <button (click)="onPageChange(totalPages)" [disabled]="currentPage === totalPages">
          ‚ü´
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <app-loading-overlay [show]="isLoading" message="ƒêang x·ª≠ l√Ω..."></app-loading-overlay>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" *ngIf="isDetailModalOpen" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Chi ti·∫øt ng∆∞·ªùi d√πng</h2>
      <button class="close-btn" (click)="closeModal()">√ó</button>
    </div>
    <div class="modal-body" *ngIf="selectedUser">
      <div class="detail-row">
        <div class="label">User ID:</div>
        <div class="value">{{ selectedUser.userId }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Username:</div>
        <div class="value">{{ selectedUser.username }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Email:</div>
        <div class="value">{{ selectedUser.email }}</div>
      </div>
      <div class="detail-row">
        <div class="label">H·ªç:</div>
        <div class="value">{{ selectedUser.firstName || 'N/A' }}</div>
      </div>
      <div class="detail-row">
        <div class="label">T√™n:</div>
        <div class="value">{{ selectedUser.lastName || 'N/A' }}</div>
      </div>
      <div class="detail-row">
        <div class="label">S·ªë ƒëi·ªán tho·∫°i:</div>
        <div class="value">{{ selectedUser.phoneNumber || 'N/A' }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Tr·∫°ng th√°i:</div>
        <div class="value">
          <span class="status-badge" [ngClass]="getStatusClass(selectedUser.status)">
            {{ getStatusLabel(selectedUser.status) }}
          </span>
        </div>
      </div>
      <div class="detail-row">
        <div class="label">Email x√°c th·ª±c:</div>
        <div class="value">{{ selectedUser.emailVerified ? 'ƒê√£ x√°c th·ª±c' : 'Ch∆∞a x√°c th·ª±c' }}</div>
      </div>
      <div class="detail-row">
        <div class="label">SƒêT x√°c th·ª±c:</div>
        <div class="value">{{ selectedUser.phoneVerified ? 'ƒê√£ x√°c th·ª±c' : 'Ch∆∞a x√°c th·ª±c' }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Ng√†y t·∫°o:</div>
        <div class="value">{{ formatDate(selectedUser.createdAt) }}</div>
      </div>
      <div class="detail-row">
        <div class="label">L·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi:</div>
        <div class="value">{{ formatDate(selectedUser.lastLoginAt) }}</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeModal()">ƒê√≥ng</button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" *ngIf="isEditModalOpen" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng</h2>
      <button class="close-btn" (click)="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Username:</label>
        <input type="text" [(ngModel)]="editForm.username" placeholder="Nh·∫≠p username" />
      </div>
      <div class="form-group">
        <label>Email:</label>
        <input type="email" [(ngModel)]="editForm.email" placeholder="Nh·∫≠p email" />
      </div>
      <div class="form-group">
        <label>M·∫≠t kh·∫©u m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi):</label>
        <input type="password" [(ngModel)]="editForm.passwordHash" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeModal()">H·ªßy</button>
      <button class="btn-primary" (click)="saveUser()">L∆∞u thay ƒë·ªïi</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="isDeleteModalOpen" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>X√°c nh·∫≠n x√≥a</h2>
      <button class="close-btn" (click)="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="delete-confirmation">
        <div class="warning-icon">‚ö†Ô∏è</div>
        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng <strong>{{ selectedUser?.username }}</strong>?</p>
        <p class="warning-text">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeModal()">H·ªßy</button>
      <button class="btn-danger" (click)="deleteUser()">X√≥a ng∆∞·ªùi d√πng</button>
    </div>
  </div>
</div>
