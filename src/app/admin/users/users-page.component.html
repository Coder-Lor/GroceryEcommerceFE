<!-- Loading Overlay for entire page -->
<app-loading-overlay [show]="isLoading" message="Đang xử lý..."></app-loading-overlay>

<div class="users-container">
  <!-- Toast messages -->
  <p-toast></p-toast>

  <!-- Confirm Dialog -->
  <p-confirmDialog [style]="{width: '450px'}" [baseZIndex]="10000" [closable]="true" [closeOnEscape]="true"
    acceptButtonStyleClass="p-button-danger" rejectButtonStyleClass="p-button-secondary p-button-text">
  </p-confirmDialog>

  <div class="page-header">
    <h2>Quản lý người dùng</h2>
    <div class="header-actions">
      <!-- Bulk actions - hiển thị khi có item được chọn -->
      <div class="bulk-actions" *ngIf="selectedUsers.length > 0">
        <span class="selected-count">Đã chọn {{ selectedUsers.length }} người dùng</span>
        <button class="btn btn-danger" (click)="confirmBulkDelete()" appTooltip="Xóa các mục đã chọn">
          <fa-icon [icon]="faTrashCan"></fa-icon>
          Xóa đã chọn
        </button>
        <button class="btn btn-secondary" (click)="clearSelection()" appTooltip="Bỏ chọn tất cả">
          <fa-icon [icon]="faXmark"></fa-icon>
          Bỏ chọn
        </button>
      </div>
      <button class="btn btn-info" (click)="loadUsers()" appTooltip="Tải lại">
        <i class="pi pi-sync"></i>
      </button>
    </div>
  </div>

  <!-- Tìm kiếm -->
  <div class="search-box">
    <div class="search-wrapper">
      <fa-icon [icon]="faMagnifyingGlass"></fa-icon>
      <input type="text" [(ngModel)]="searchTerm" (input)="filterUsers()"
        placeholder="Tìm kiếm theo username, email, họ tên, số điện thoại..." class="search-input" />
    </div>
    <span class="search-result">Hiển thị {{ filteredUsers.length }} / {{ users.length }} người dùng</span>
  </div>

  <!-- Bảng danh sách người dùng -->
  <div class="table-container">
    <table class="user-table">
      <thead>
        <tr>
          <th class="checkbox-column">
            <input type="checkbox" [checked]="isAllSelected()" [indeterminate]="isIndeterminate()"
              (change)="toggleSelectAll($event)" class="select-checkbox" />
          </th>
          <th (click)="changeSortColumn('username')" class="sortable">
            Username
            <span class="sort-icon">
              <fa-icon
                [icon]="sortColumn === 'username' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th (click)="changeSortColumn('email')" class="sortable">
            Email
            <span class="sort-icon">
              <fa-icon
                [icon]="sortColumn === 'email' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th>Họ tên</th>
          <th>Số điện thoại</th>
          <th (click)="changeSortColumn('status')" class="sortable text-center">
            Trạng thái
            <span class="sort-icon">
              <fa-icon
                [icon]="sortColumn === 'status' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th class="text-center">Email xác thực</th>
          <th (click)="changeSortColumn('createdAt')" class="sortable text-center">
            Ngày tạo
            <span class="sort-icon">
              <fa-icon
                [icon]="sortColumn === 'createdAt' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th class="text-center">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers" [class.selected-row]="isUserSelected(user.userId!)">
          <td class="checkbox-column">
            <input type="checkbox" [checked]="isUserSelected(user.userId!)" (change)="toggleUserSelection(user.userId!)"
              class="select-checkbox" (click)="$event.stopPropagation()" />
          </td>
          <td>
            <div class="user-name">
              <fa-icon [icon]="faUser" class="user-icon"></fa-icon>
              {{ user.username || '' }}
            </div>
          </td>
          <td class="email">
            <fa-icon [icon]="faEnvelope" class="icon-small"></fa-icon>
            {{ user.email || '' }}
          </td>
          <td>{{ (user.firstName || '') + ' ' + (user.lastName || '') || 'N/A' }}</td>
          <td>
            <span *ngIf="user.phoneNumber">
              <fa-icon [icon]="faPhone" class="icon-small"></fa-icon>
              {{ user.phoneNumber }}
            </span>
            <span *ngIf="!user.phoneNumber">N/A</span>
          </td>
          <td class="text-center">
            <span [class]="'status-badge ' + getStatusClass(user.status)">
              {{ getStatusLabel(user.status) }}
            </span>
          </td>
          <td class="text-center">
            <span class="verified-badge" [ngClass]="user.emailVerified ? 'verified' : 'unverified'">
              <fa-icon [icon]="user.emailVerified ? faUserCheck : faUserSlash"></fa-icon>
              {{ user.emailVerified ? 'Đã xác thực' : 'Chưa xác thực' }}
            </span>
          </td>
          <td class="text-center">
            <fa-icon [icon]="faCalendar" class="icon-small"></fa-icon>
            {{ formatDate(user.createdAt) }}
          </td>
          <td class="text-center actions">
            <button class="btn-icon btn-action-menu" (click)="showActionMenu($event, user)" appTooltip="Thao tác">
              <fa-icon [icon]="faEllipsisVertical"></fa-icon>
            </button>
          </td>
        </tr>
        <tr *ngIf="filteredUsers.length === 0">
          <td colspan="9" class="no-data">Không tìm thấy người dùng nào</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <div class="pagination-container">
    <div class="pagination-info">
      <span>Hiển thị trang {{ currentPage }} / {{ totalPages }}</span>
      <div class="page-size-selector">
        <label for="pageSize">Số người dùng mỗi trang:</label>
        <select id="pageSize" [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="page-size-select">
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </div>
    </div>

    <div class="pagination-controls">
      <button class="btn-pagination" (click)="onPageChange(1)" [disabled]="currentPage === 1" appTooltip="Trang đầu">
        <fa-icon [icon]="faAnglesLeft"></fa-icon>
      </button>

      <button class="btn-pagination" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1"
        appTooltip="Trang trước">
        <fa-icon [icon]="faChevronLeft"></fa-icon>
      </button>

      <div class="page-numbers">
        <button *ngFor="let page of getPageNumbers()" class="btn-page" [class.active]="page === currentPage"
          (click)="onPageChange(page)">
          {{ page }}
        </button>
      </div>

      <button class="btn-pagination" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages"
        appTooltip="Trang sau">
        <fa-icon [icon]="faChevronRight"></fa-icon>
      </button>

      <button class="btn-pagination" (click)="onPageChange(totalPages)" [disabled]="currentPage === totalPages"
        appTooltip="Trang cuối">
        <fa-icon [icon]="faAnglesRight"></fa-icon>
      </button>
    </div>
  </div>
</div>

<!-- Modal xem chi tiết -->
<div class="modal-overlay" *ngIf="isDetailModalOpen" (click)="closeModal()">
  <div class="modal-content detail-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <fa-icon [icon]="faUser"></fa-icon>
        Chi tiết người dùng
      </h3>
      <button class="btn-close" (click)="closeModal()">
        <fa-icon [icon]="faXmark"></fa-icon>
      </button>
    </div>

    <div class="modal-body" *ngIf="selectedUser">
      <div class="detail-row">
        <div class="label">User ID:</div>
        <div class="value">{{ selectedUser.userId }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Username:</div>
        <div class="value">{{ selectedUser.username }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Email:</div>
        <div class="value">{{ selectedUser.email }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Họ:</div>
        <div class="value">{{ selectedUser.firstName || 'N/A' }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Tên:</div>
        <div class="value">{{ selectedUser.lastName || 'N/A' }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Số điện thoại:</div>
        <div class="value">{{ selectedUser.phoneNumber || 'N/A' }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Trạng thái:</div>
        <div class="value">
          <span class="status-badge" [ngClass]="getStatusClass(selectedUser.status)">
            {{ getStatusLabel(selectedUser.status) }}
          </span>
        </div>
      </div>
      <div class="detail-row">
        <div class="label">Email xác thực:</div>
        <div class="value">
          <span class="verified-badge" [ngClass]="selectedUser.emailVerified ? 'verified' : 'unverified'">
            <fa-icon [icon]="selectedUser.emailVerified ? faUserCheck : faUserSlash"></fa-icon>
            {{ selectedUser.emailVerified ? 'Đã xác thực' : 'Chưa xác thực' }}
          </span>
        </div>
      </div>
      <div class="detail-row">
        <div class="label">SĐT xác thực:</div>
        <div class="value">{{ selectedUser.phoneVerified ? 'Đã xác thực' : 'Chưa xác thực' }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Ngày tạo:</div>
        <div class="value">{{ formatDate(selectedUser.createdAt) }}</div>
      </div>
      <div class="detail-row">
        <div class="label">Lần đăng nhập cuối:</div>
        <div class="value">{{ formatDate(selectedUser.lastLoginAt) }}</div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Đóng</button>
    </div>
  </div>
</div>

<!-- Modal chỉnh sửa -->
<div class="modal-overlay" *ngIf="isEditModalOpen" (click)="closeModal()">
  <div class="modal-content edit-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <fa-icon [icon]="faPenToSquare"></fa-icon>
        Chỉnh sửa người dùng
      </h3>
      <button class="btn-close" (click)="closeModal()">
        <fa-icon [icon]="faXmark"></fa-icon>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label>
          Username <span class="required">*</span>
        </label>
        <input type="text" class="form-control" [(ngModel)]="editForm.username" placeholder="Nhập username" />
      </div>
      <div class="form-group">
        <label>
          Email <span class="required">*</span>
        </label>
        <input type="email" class="form-control" [(ngModel)]="editForm.email" placeholder="Nhập email" />
      </div>
      <div class="form-group">
        <label>Mật khẩu mới (để trống nếu không đổi)</label>
        <input type="password" class="form-control" [(ngModel)]="editForm.passwordHash"
          placeholder="Nhập mật khẩu mới" />
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Hủy</button>
      <button class="btn btn-primary" (click)="saveUser()">Lưu thay đổi</button>
    </div>
  </div>
</div>

<!-- Modal quản lý vai trò -->
<div class="modal-overlay" *ngIf="isRoleModalOpen" (click)="closeModal()">
  <div class="modal-content role-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <fa-icon [icon]="faUserShield"></fa-icon>
        Quản lý vai trò - {{ selectedUser?.username }}
      </h3>
      <button class="btn-close" (click)="closeModal()">
        <fa-icon [icon]="faXmark"></fa-icon>
      </button>
    </div>

    <div class="modal-body">
      <div class="current-roles" *ngIf="userRoles.length > 0">
        <h4>
          <fa-icon [icon]="faUserTag"></fa-icon>
          Vai trò hiện tại:
        </h4>
        <div class="role-badges">
          <span class="role-badge current" *ngFor="let role of userRoles">
            {{ role }}
          </span>
        </div>
      </div>

      <div class="available-roles">
        <h4>Chọn vai trò:</h4>
        <div class="roles-grid">
          <label class="role-checkbox" *ngFor="let role of availableRoles">
            <input type="checkbox" [checked]="isRoleSelected(role.roleId!)" (change)="toggleRole(role.roleId!)" />
            <span class="role-name">{{ role.roleName }}</span>
            <span class="role-description" *ngIf="role.description">{{ role.description }}</span>
          </label>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Hủy</button>
      <button class="btn btn-primary" (click)="saveRoles()">
        <fa-icon [icon]="faUserShield"></fa-icon>
        Lưu vai trò
      </button>
    </div>
  </div>
</div>

<!-- Action Menu Popup -->
<p-menu #actionMenu [model]="actionMenuItems" [popup]="true" appendTo="body" styleClass="action-menu"></p-menu>