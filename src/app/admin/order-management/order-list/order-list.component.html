<!-- Loading Overlay for entire page -->
<app-loading-overlay [show]="isLoading" message="Đang xử lý..."></app-loading-overlay>

<div class="inventory-container">
  <!-- Toast messages -->
  <p-toast></p-toast>

  <!-- Confirm Dialog -->
  <p-confirmDialog [style]="{width: '450px'}" [baseZIndex]="10000" [closable]="true" [closeOnEscape]="true"
    acceptButtonStyleClass="p-button-danger" rejectButtonStyleClass="p-button-secondary p-button-text">
  </p-confirmDialog>

  <div class="page-header">
    <h2>Quản lý đơn hàng</h2>
    <div class="header-actions">
      <button class="btn btn-info" (click)="loadOrders()" appTooltip="Tải lại">
        <fa-icon [icon]="faRefresh" size="1x"></fa-icon>
      </button>
    </div>
  </div>

  <!-- Tìm kiếm -->
  <div class="search-box">
    <div class="search-wrapper">
      <input type="text" [(ngModel)]="searchTerm" (keyup.enter)="onSearch()"
        placeholder="Tìm kiếm theo mã đơn hàng, tên khách hàng..." class="search-input" />
      <button type="button" class="btn search-button" (click)="onSearch()" [disabled]="isLoading" appTooltip="Tìm kiếm">
        <fa-icon [icon]="faMagnifyingGlass"></fa-icon>
      </button>
    </div>
    <span class="search-result">Hiển thị {{ filteredOrders.length }} / {{ totalRecords }} đơn hàng</span>
  </div>

  <!-- Bảng danh sách đơn hàng -->
  <div class="table-container">
    <table class="product-table">
      <thead>
        <tr>
          <th (click)="changeSortColumn('orderNumber')" class="sortable">
            Mã đơn hàng
            <span class="sort-icon">
              <fa-icon
                [icon]="sortColumn === 'orderNumber' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th (click)="changeSortColumn('customerName')" class="sortable">
            Khách hàng
            <span class="sort-icon">
              <fa-icon
                [icon]="sortColumn === 'customerName' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th (click)="changeSortColumn('orderDate')" class="sortable">
            Ngày đặt
            <span class="sort-icon">
              <fa-icon
                [icon]="sortColumn === 'orderDate' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th (click)="changeSortColumn('totalAmount')" class="sortable text-right">
            Tổng tiền
            <span class="sort-icon">
              <fa-icon
                [icon]="sortColumn === 'totalAmount' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th>Trạng thái đơn</th>
          <th>Thanh toán</th>
          <th (click)="changeSortColumn('createdAt')" class="sortable text-center">
            Ngày tạo
            <span class="sort-icon">
              <fa-icon
                [icon]="sortColumn === 'createdAt' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th class="text-center">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of filteredOrders">
          <td>
            <div class="order-number">
              <fa-icon [icon]="faTag" class="order-icon"></fa-icon>
              <strong>{{ order.orderNumber || order.orderId || 'N/A' }}</strong>
            </div>
          </td>
          <td>{{ order.userName || 'N/A' }}</td>
          <td>
            <fa-icon [icon]="faCalendar" class="icon-small"></fa-icon>
            {{ formatDate(order.orderDate) }}
          </td>
          <td class="text-right">
            <strong class="amount">{{ formatCurrency(order.totalAmount) }}</strong>
          </td>
          <td>
            <span class="status-badge" [ngClass]="getStatusBadgeClass(order.status || 1)">
              {{ OrderStatusMapper.getOrderStatusDisplay(order.status || 1) }}
            </span>
          </td>
          <td>
            <span class="status-badge" [ngClass]="getPaymentBadgeClass(order.paymentStatus || 1)">
              {{ OrderStatusMapper.getPaymentStatusDisplay(order.paymentStatus || 1) }}
            </span>
          </td>
          <td class="text-center">
            <fa-icon [icon]="faCalendar" class="icon-small"></fa-icon>
            {{ formatDate(order.createdAt) }}
          </td>
          <td class="text-center actions">
            <button class="btn-icon btn-view" (click)="viewOrderDetail(order.orderId!)" appTooltip="Xem chi tiết">
              <fa-icon [icon]="faEye"></fa-icon>
            </button>
            <button class="btn-icon btn-export" (click)="exportInvoice(order.orderId!)" appTooltip="Xuất hóa đơn PDF">
              <fa-icon [icon]="faFileInvoice"></fa-icon>
            </button>
            <button class="btn-icon btn-delete" (click)="confirmDelete(order)" appTooltip="Xóa">
              <fa-icon [icon]="faTrashCan"></fa-icon>
            </button>
          </td>
        </tr>
        <tr *ngIf="filteredOrders.length === 0">
          <td colspan="8" class="no-data">Không tìm thấy đơn hàng nào</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <div class="pagination-container">
    <div class="pagination-info">
      <span>Hiển thị trang {{ currentPage }} / {{ totalPages }}</span>
      <div class="page-size-selector">
        <label for="pageSize">Số đơn hàng mỗi trang:</label>
        <select id="pageSize" [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="page-size-select">
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </div>
    </div>

    <div class="pagination-controls">
      <button class="btn-pagination" (click)="onPageChange(1)" [disabled]="currentPage === 1" appTooltip="Trang đầu">
        <fa-icon [icon]="faAnglesLeft"></fa-icon>
      </button>

      <button class="btn-pagination" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1"
        appTooltip="Trang trước">
        <fa-icon [icon]="faChevronLeft"></fa-icon>
      </button>

      <div class="page-numbers">
        <button *ngFor="let page of getPageNumbers()" class="btn-page" [class.active]="page === currentPage"
          (click)="onPageChange(page)">
          {{ page }}
        </button>
      </div>

      <button class="btn-pagination" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages"
        appTooltip="Trang sau">
        <fa-icon [icon]="faChevronRight"></fa-icon>
      </button>

      <button class="btn-pagination" (click)="onPageChange(totalPages)" [disabled]="currentPage === totalPages"
        appTooltip="Trang cuối">
        <fa-icon [icon]="faAnglesRight"></fa-icon>
      </button>
    </div>
  </div>
</div>

<!-- Modal xem chi tiết đơn hàng -->
<div class="modal-overlay" *ngIf="isDetailModalOpen" (click)="closeModal()">
  <div class="modal-content detail-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <fa-icon [icon]="faEye"></fa-icon>
        Chi tiết đơn hàng
      </h3>
      <button class="btn-close" (click)="closeModal()">
        <fa-icon [icon]="faXmark"></fa-icon>
      </button>
    </div>

    <div class="modal-body" *ngIf="selectedOrder">
      <div class="detail-section">
        <h4>Thông tin đơn hàng</h4>
        <div class="detail-row" *ngFor="let key of getObjectKeys(selectedOrder)">
          <div class="label">{{ formatKey(key) }}:</div>
          <div class="value">
            <span *ngIf="key === 'status'" class="status-badge" [ngClass]="getStatusBadgeClass(selectedOrder[key])">
              {{ formatValue(selectedOrder[key], key) }}
            </span>
            <span *ngIf="key === 'paymentStatus'" class="status-badge"
              [ngClass]="getPaymentBadgeClass(selectedOrder[key])">
              {{ formatValue(selectedOrder[key], key) }}
            </span>
            <span *ngIf="key !== 'status' && key !== 'paymentStatus'">
              {{ formatValue(selectedOrder[key], key) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Đóng</button>
    </div>
  </div>
</div>