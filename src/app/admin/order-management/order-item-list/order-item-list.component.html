<app-loading-overlay [show]="isLoading" message="Đang xử lý..."></app-loading-overlay>
<div class="list-container">
  <p-toast></p-toast>
  <p-confirmDialog [style]="{width: '450px'}" [baseZIndex]="10000" [closable]="true" acceptButtonStyleClass="p-button-danger" rejectButtonStyleClass="p-button-secondary p-button-text"></p-confirmDialog>
  
  <div class="list-header">
    <h3><fa-icon [icon]="faShoppingCart"></fa-icon> Danh sách sản phẩm đơn hàng</h3>
    <div class="header-actions">
      <button class="btn btn-info" (click)="loadItems()" appTooltip="Tải lại"><fa-icon [icon]="faRefresh" size="1x"></fa-icon></button>
    </div>
  </div>

  <div class="filters-box">
    <div class="search-box">
      <div class="search-wrapper">
        <fa-icon [icon]="faMagnifyingGlass"></fa-icon>
        <input type="text" [(ngModel)]="searchTerm" (keyup.enter)="onSearch()" placeholder="Tìm kiếm..." class="search-input" />
        <button class="btn-search" (click)="onSearch()"><fa-icon [icon]="faMagnifyingGlass"></fa-icon></button>
      </div>
      <span class="search-result">Hiển thị {{ filteredItems.length }} / {{ totalRecords }} sản phẩm đơn hàng</span>
    </div>
  </div>

  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th (click)="changeSortColumn('orderItemId')" class="sortable">ID <span class="sort-icon"><fa-icon [icon]="sortColumn === 'orderItemId' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon></span></th>
          <th>ID Đơn hàng</th>
          <th>Sản phẩm</th>
          <th class="text-center">Số lượng</th>
          <th (click)="changeSortColumn('unitPrice')" class="sortable text-right">Đơn giá <span class="sort-icon"><fa-icon [icon]="sortColumn === 'unitPrice' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon></span></th>
          <th class="text-right">Thành tiền</th>
          <th class="text-center">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filteredItems">
          <td><strong>{{ item.orderItemId || 'N/A' }}</strong></td>
          <td>{{ item.orderId || 'N/A' }}</td>
          <td>{{ item.productName || 'N/A' }}</td>
          <td class="text-center">{{ item.quantity || 0 }}</td>
          <td class="text-right"><strong class="amount">{{ formatCurrency(item.unitPrice) }}</strong></td>
          <td class="text-right"><strong class="amount">{{ formatCurrency(item.totalPrice) }}</strong></td>
          <td class="text-center actions">
            <button class="btn-icon btn-view" (click)="viewDetail(item.orderItemId!)" appTooltip="Xem chi tiết"><fa-icon [icon]="faEye"></fa-icon></button>
            <button class="btn-icon btn-delete" (click)="confirmDelete(item)" appTooltip="Xóa"><fa-icon [icon]="faTrashCan"></fa-icon></button>
          </td>
        </tr>
        <tr *ngIf="filteredItems.length === 0"><td colspan="7" class="no-data">Không tìm thấy sản phẩm đơn hàng nào</td></tr>
      </tbody>
    </table>
  </div>

  <div class="pagination-container">
    <div class="pagination-info">
      <span>Hiển thị trang {{ currentPage }} / {{ totalPages }}</span>
      <div class="page-size-selector">
        <label for="pageSize">Số mục mỗi trang:</label>
        <select id="pageSize" [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="page-size-select">
          <option [value]="10">10</option><option [value]="20">20</option><option [value]="50">50</option><option [value]="100">100</option>
        </select>
      </div>
    </div>
    <div class="pagination-controls">
      <button class="btn-pagination" (click)="onPageChange(1)" [disabled]="currentPage === 1" appTooltip="Trang đầu"><fa-icon [icon]="faAnglesLeft"></fa-icon></button>
      <button class="btn-pagination" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1" appTooltip="Trang trước"><fa-icon [icon]="faChevronLeft"></fa-icon></button>
      <div class="page-numbers">
        <button *ngFor="let page of getPageNumbers()" class="btn-page" [class.active]="page === currentPage" (click)="onPageChange(page)">{{ page }}</button>
      </div>
      <button class="btn-pagination" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages" appTooltip="Trang sau"><fa-icon [icon]="faChevronRight"></fa-icon></button>
      <button class="btn-pagination" (click)="onPageChange(totalPages)" [disabled]="currentPage === totalPages" appTooltip="Trang cuối"><fa-icon [icon]="faAnglesRight"></fa-icon></button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="isDetailModalOpen" (click)="closeModal()">
  <div class="modal-content detail-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><fa-icon [icon]="faEye"></fa-icon> Chi tiết sản phẩm đơn hàng</h3>
      <button class="btn-close" (click)="closeModal()"><fa-icon [icon]="faXmark"></fa-icon></button>
    </div>
    <div class="modal-body" *ngIf="selectedItem">
      <div class="detail-section">
        <h4>Thông tin sản phẩm đơn hàng</h4>
        <div class="detail-row" *ngFor="let key of getObjectKeys(selectedItem)">
          <div class="label">{{ formatKey(key) }}:</div>
          <div class="value">{{ formatValue(selectedItem[key], key) }}</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Đóng</button>
    </div>
  </div>
</div>

