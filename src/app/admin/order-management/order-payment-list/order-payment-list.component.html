<app-loading-overlay [show]="isLoading" message="Đang xử lý..."></app-loading-overlay>

<div class="list-container">
  <p-toast></p-toast>
  <p-confirmDialog
    [style]="{width: '450px'}"
    [baseZIndex]="10000"
    [closable]="true"
    acceptButtonStyleClass="p-button-danger"
    rejectButtonStyleClass="p-button-secondary p-button-text">
  </p-confirmDialog>
  
  <div class="list-header">
    <h3>
      <fa-icon [icon]="faCreditCard"></fa-icon>
      Danh sách thanh toán đơn hàng
    </h3>
    <div class="header-actions">
      <button class="btn btn-info" (click)="loadPayments()" appTooltip="Tải lại">
        <fa-icon [icon]="faRefresh" size="1x"></fa-icon>
      </button>
    </div>
  </div>

  <div class="filters-box">
    <div class="search-box">
      <div class="search-wrapper">
        <fa-icon [icon]="faMagnifyingGlass"></fa-icon>
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (keyup.enter)="onSearch()"
          placeholder="Tìm kiếm..."
          class="search-input"
        />
        <button class="btn-search" (click)="onSearch()">
          <fa-icon [icon]="faMagnifyingGlass"></fa-icon>
        </button>
      </div>
      <span class="search-result">Hiển thị {{ filteredPayments.length }} / {{ totalRecords }} thanh toán</span>
    </div>
  </div>

  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th (click)="changeSortColumn('orderPaymentId')" class="sortable">
            ID Thanh toán
            <span class="sort-icon">
              <fa-icon [icon]="sortColumn === 'orderPaymentId' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th>ID Đơn hàng</th>
          <th>Phương thức</th>
          <th (click)="changeSortColumn('amount')" class="sortable text-right">
            Số tiền
            <span class="sort-icon">
              <fa-icon [icon]="sortColumn === 'amount' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th>Trạng thái</th>
          <th (click)="changeSortColumn('processedAt')" class="sortable">
            Ngày xử lý
            <span class="sort-icon">
              <fa-icon [icon]="sortColumn === 'processedAt' ? (sortDirection === 'asc' ? faSortUp : faSortDown) : faSort"></fa-icon>
            </span>
          </th>
          <th class="text-center">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let payment of filteredPayments">
          <td><strong>{{ payment.orderPaymentId || 'N/A' }}</strong></td>
          <td>{{ payment.orderId || 'N/A' }}</td>
          <td>{{ payment.paymentMethodName || payment.paymentMethod || 'N/A' }}</td>
          <td class="text-right"><strong class="amount">{{ formatCurrency(payment.amount) }}</strong></td>
          <td><span class="status-badge">{{ payment.statusName || payment.status || 'N/A' }}</span></td>
          <td><fa-icon [icon]="faCalendar" class="icon-small"></fa-icon>{{ formatDate(payment.processedAt || payment.createdAt) }}</td>
          <td class="text-center actions">
            <button class="btn-icon btn-view" (click)="viewDetail(payment.orderPaymentId!)" appTooltip="Xem chi tiết">
              <fa-icon [icon]="faEye"></fa-icon>
            </button>
            <button class="btn-icon btn-delete" (click)="confirmDelete(payment)" appTooltip="Xóa">
              <fa-icon [icon]="faTrashCan"></fa-icon>
            </button>
          </td>
        </tr>
        <tr *ngIf="filteredPayments.length === 0">
          <td colspan="7" class="no-data">Không tìm thấy thanh toán nào</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination-container">
    <div class="pagination-info">
      <span>Hiển thị trang {{ currentPage }} / {{ totalPages }}</span>
      <div class="page-size-selector">
        <label for="pageSize">Số mục mỗi trang:</label>
        <select id="pageSize" [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="page-size-select">
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </div>
    </div>
    <div class="pagination-controls">
      <button class="btn-pagination" (click)="onPageChange(1)" [disabled]="currentPage === 1" appTooltip="Trang đầu">
        <fa-icon [icon]="faAnglesLeft"></fa-icon>
      </button>
      <button class="btn-pagination" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1" appTooltip="Trang trước">
        <fa-icon [icon]="faChevronLeft"></fa-icon>
      </button>
      <div class="page-numbers">
        <button *ngFor="let page of getPageNumbers()" class="btn-page" [class.active]="page === currentPage" (click)="onPageChange(page)">
          {{ page }}
        </button>
      </div>
      <button class="btn-pagination" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages" appTooltip="Trang sau">
        <fa-icon [icon]="faChevronRight"></fa-icon>
      </button>
      <button class="btn-pagination" (click)="onPageChange(totalPages)" [disabled]="currentPage === totalPages" appTooltip="Trang cuối">
        <fa-icon [icon]="faAnglesRight"></fa-icon>
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="isDetailModalOpen" (click)="closeModal()">
  <div class="modal-content detail-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><fa-icon [icon]="faEye"></fa-icon> Chi tiết thanh toán</h3>
      <button class="btn-close" (click)="closeModal()"><fa-icon [icon]="faXmark"></fa-icon></button>
    </div>
    <div class="modal-body" *ngIf="selectedPayment">
      <div class="detail-section">
        <h4>Thông tin thanh toán</h4>
        <div class="detail-row" *ngFor="let key of getObjectKeys(selectedPayment)">
          <div class="label">{{ formatKey(key) }}:</div>
          <div class="value">{{ formatValue(selectedPayment[key], key) }}</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Đóng</button>
    </div>
  </div>
</div>

