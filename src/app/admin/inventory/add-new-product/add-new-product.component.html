<div class="add-product-container">
  <!-- Toast messages -->
  <p-toast></p-toast>
  
  <!-- Confirm Dialog -->
  <p-confirmDialog
    [style]="{width: '450px'}"
    [baseZIndex]="10000"
    [closable]="true"
    [closeOnEscape]="true"
    acceptButtonStyleClass="p-button-danger"
    rejectButtonStyleClass="p-button-secondary p-button-text">
  </p-confirmDialog>
  
  <div class="page-header">
    <button class="btn-back" (click)="goBack()">
      <fa-icon [icon]="faArrowLeft"></fa-icon>
      Quay lại
    </button>
    <h2>Thêm sản phẩm mới</h2>
    <button class="btn-generate-sample" (click)="generateSampleData()" type="button">
      <fa-icon [icon]="faMagic"></fa-icon>
      Sinh dữ liệu mẫu
    </button>
  </div>

  <div class="form-container">
    <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
      <!-- Basic Information Section -->
      <div class="form-section">
        <h3 class="section-title">Thông tin cơ bản</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label>Mã SKU <span class="required">*</span></label>
            <input
              type="text"
              formControlName="sku"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('sku')"
              placeholder="Nhập mã SKU"
            />
            <div class="error-message" *ngIf="isFieldInvalid('sku')">
              {{ getErrorMessage('sku') }}
            </div>
          </div>

          <div class="form-group">
            <label>Slug</label>
            <input
              type="text"
              formControlName="slug"
              class="form-control"
              placeholder="Nhập slug (tự động tạo nếu để trống)"
            />
          </div>
        </div>

        <div class="form-group">
          <label>Tên sản phẩm <span class="required">*</span></label>
          <input
            type="text"
            formControlName="name"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('name')"
            placeholder="Nhập tên sản phẩm"
          />
          <div class="error-message" *ngIf="isFieldInvalid('name')">
            {{ getErrorMessage('name') }}
          </div>
        </div>

        <div class="form-group">
          <label>Danh mục <span class="required">*</span></label>
          <button type="button" class="btn-select-category" (click)="openCategoryModal()">
            <fa-icon [icon]="faFolder"></fa-icon>
            <span *ngIf="!selectedCategory">Chọn danh mục</span>
            <span *ngIf="selectedCategory">{{ selectedCategory.name }}</span>
          </button>
          <div class="error-message" *ngIf="isFieldInvalid('categoryId')">
            {{ getErrorMessage('categoryId') }}
          </div>
        </div>

        <div class="form-group">
          <label>Mô tả ngắn</label>
          <input
            type="text"
            formControlName="shortDescription"
            class="form-control"
            placeholder="Nhập mô tả ngắn"
          />
        </div>

        <div class="form-group">
          <label>Mô tả chi tiết</label>
          <textarea
            formControlName="description"
            class="form-control"
            rows="5"
            placeholder="Nhập mô tả chi tiết về sản phẩm"
          ></textarea>
        </div>
      </div>

      <!-- Pricing Section -->
      <div class="form-section">
        <h3 class="section-title">Thông tin giá</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label>Giá vốn <span class="required">*</span></label>
            <input
              type="number"
              formControlName="cost"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('cost')"
              min="0"
              step="1000"
              placeholder="0"
            />
            <div class="error-message" *ngIf="isFieldInvalid('cost')">
              {{ getErrorMessage('cost') }}
            </div>
          </div>

          <div class="form-group">
            <label>Giá bán <span class="required">*</span></label>
            <input
              type="number"
              formControlName="price"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('price')"
              min="0"
              step="1000"
              placeholder="0"
            />
            <div class="error-message" *ngIf="isFieldInvalid('price')">
              {{ getErrorMessage('price') }}
            </div>
          </div>

          <div class="form-group">
            <label>Giá giảm</label>
            <input
              type="number"
              formControlName="discountPrice"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('discountPrice')"
              min="0"
              step="1000"
              placeholder="0"
            />
            <div class="error-message" *ngIf="isFieldInvalid('discountPrice')">
              {{ getErrorMessage('discountPrice') }}
            </div>
          </div>
        </div>
      </div>

      <!-- Inventory Section -->
      <div class="form-section">
        <h3 class="section-title">Thông tin kho hàng</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label>Số lượng tồn kho <span class="required">*</span></label>
            <input
              type="number"
              formControlName="stockQuantity"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('stockQuantity')"
              min="0"
              placeholder="0"
            />
            <div class="error-message" *ngIf="isFieldInvalid('stockQuantity')">
              {{ getErrorMessage('stockQuantity') }}
            </div>
          </div>

          <div class="form-group">
            <label>Mức tồn tối thiểu <span class="required">*</span></label>
            <input
              type="number"
              formControlName="minStockLevel"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('minStockLevel')"
              min="0"
              placeholder="10"
            />
            <div class="error-message" *ngIf="isFieldInvalid('minStockLevel')">
              {{ getErrorMessage('minStockLevel') }}
            </div>
          </div>
        </div>
      </div>

      <!-- Physical Properties Section -->
      <div class="form-section">
        <h3 class="section-title">Thông tin vật lý</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label>Trọng lượng (kg)</label>
            <input
              type="number"
              formControlName="weight"
              class="form-control"
              min="0"
              step="0.01"
              placeholder="0.00"
            />
          </div>

          <div class="form-group">
            <label>Kích thước (DxRxC mm)</label>
            <input
              type="text"
              formControlName="dimensions"
              class="form-control"
              placeholder="VD: 100x200x50"
            />
          </div>
        </div>
      </div>

      <!-- Additional Information Section -->
      <div class="form-section">
        <h3 class="section-title">Thông tin bổ sung</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label>Brand ID</label>
            <input
              type="text"
              formControlName="brandId"
              class="form-control"
              placeholder="Nhập Brand ID (nếu có)"
            />
          </div>

          <div class="form-group">
            <label>Trạng thái</label>
            <select formControlName="status" class="form-control">
              <option [value]="1">Hoạt động</option>
              <option [value]="2">Nháp</option>
              <option [value]="3">Đã lưu trữ</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" formControlName="isFeatured" />
              <span>Sản phẩm nổi bật</span>
            </label>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" formControlName="isDigital" />
              <span>Sản phẩm số</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Variants Section -->
      <div class="form-section">
        <div class="section-header">
          <h3 class="section-title">
            <fa-icon [icon]="faCubes"></fa-icon>
            Phân loại sản phẩm
          </h3>
          <button 
            type="button" 
            class="btn btn-sm btn-success"
            (click)="openAddVariantModal()"
          >
            <fa-icon [icon]="faPlus"></fa-icon>
            Thêm phân loại
          </button>
        </div>

        @if (variants.length === 0) {
        <div class="empty-state">
          <fa-icon [icon]="faCubes" size="3x" class="text-muted"></fa-icon>
          <p class="text-muted mt-3">Chưa có phân loại nào. Click "Thêm phân loại" để tạo phân loại mới.</p>
        </div>
        } @else {
        <div class="variants-list">
          @for (variant of variants; track $index) {
          <div class="variant-item">
            <div class="variant-content">
              <div class="variant-image">
                @if (variant.imageUrl) {
                <img [src]="variant.imageUrl" [alt]="variant.name || 'Variant image'" />
                } @else {
                <div class="no-image">
                  <fa-icon [icon]="faImage" size="2x"></fa-icon>
                </div>
                }
              </div>
              
              <div class="variant-info">
                <div class="variant-name">
                  <strong>{{ variant.name || 'phân loại ' + ($index + 1) }}</strong>
                  <span class="variant-status" [ngClass]="getVariantStatusClass(variant.status)">
                    {{ getVariantStatusText(variant.status) }}
                  </span>
                </div>
                <div class="variant-details">
                  <span class="detail-item">
                    <strong>SKU:</strong> {{ variant.sku }}
                  </span>
                  <span class="detail-item">
                    <strong>Giá:</strong> {{ formatCurrency(variant.price) }}
                  </span>
                  @if (variant.discountPrice) {
                  <span class="detail-item">
                    <strong>Giá giảm:</strong> {{ formatCurrency(variant.discountPrice) }}
                  </span>
                  }
                  <span class="detail-item">
                    <strong>Tồn kho:</strong> {{ variant.stockQuantity }}
                  </span>
                  <span class="detail-item">
                    <strong>Tối thiểu:</strong> {{ variant.minStockLevel }}
                  </span>
                </div>
              </div>
            </div>

            <div class="variant-actions">
              <button 
                type="button" 
                class="btn-icon btn-edit"
                (click)="openEditVariantModal(variant, $index)"
                title="Chỉnh sửa"
              >
                <fa-icon [icon]="faPenToSquare"></fa-icon>
              </button>
              <button 
                type="button" 
                class="btn-icon btn-delete"
                (click)="deleteVariant($index)"
                title="Xóa"
              >
                <fa-icon [icon]="faTrash"></fa-icon>
              </button>
            </div>
          </div>
          }
        </div>
        }
      </div>

      <!-- SEO Section -->
      <div class="form-section">
        <h3 class="section-title">SEO</h3>
        
        <div class="form-group">
          <label>Meta Title</label>
          <input
            type="text"
            formControlName="metaTitle"
            class="form-control"
            placeholder="Nhập tiêu đề SEO"
            maxlength="60"
          />
          <small class="form-hint">Tối đa 60 ký tự</small>
        </div>

        <div class="form-group">
          <label>Meta Description</label>
          <textarea
            formControlName="metaDescription"
            class="form-control"
            rows="3"
            placeholder="Nhập mô tả SEO"
            maxlength="160"
          ></textarea>
          <small class="form-hint">Tối đa 160 ký tự</small>
        </div>
      </div>

      <!-- Image Upload Section -->
      <div class="form-section">
        <h3 class="section-title">Hình ảnh sản phẩm</h3>
        
        <!-- Upload Area -->
        <div 
          class="image-upload-area"
          [class.dragging]="isDragging"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="triggerFileInput()"
        >
          <input
            type="file"
            id="imageFileInput"
            multiple
            accept="image/*"
            (change)="onFileSelected($event)"
            style="display: none;"
          />
          <div class="upload-content">
            <fa-icon [icon]="faCloudUpload" class="upload-icon"></fa-icon>
            <p class="upload-text">Kéo thả ảnh vào đây hoặc click để chọn</p>
            <p class="upload-hint">Hỗ trợ: JPG, PNG, GIF (Tối đa 5MB mỗi ảnh)</p>
          </div>
        </div>

        <!-- Image Preview List -->
        <div class="image-preview-list" *ngIf="selectedImages.length > 0">
          <div 
            *ngFor="let image of selectedImages; let i = index" 
            class="image-preview-item"
            [class.primary]="image.isPrimary"
          >
            <div class="image-preview-wrapper">
              <img [src]="image.preview" [alt]="image.altText || 'Preview'" />
              <div class="image-overlay">
                <button 
                  type="button" 
                  class="btn-icon btn-primary-img" 
                  (click)="setPrimaryImage(i)"
                  [class.active]="image.isPrimary"
                  title="Đặt làm ảnh chính"
                >
                  <fa-icon [icon]="faStar"></fa-icon>
                </button>
                <button 
                  type="button" 
                  class="btn-icon btn-delete" 
                  (click)="removeImage(i)"
                  title="Xóa ảnh"
                >
                  <fa-icon [icon]="faTrash"></fa-icon>
                </button>
              </div>
              <span class="primary-badge" *ngIf="image.isPrimary">
                <fa-icon [icon]="faStar"></fa-icon> Ảnh chính
              </span>
            </div>
            <div class="image-info">
              <input
                type="text"
                class="form-control"
                placeholder="Nhập mô tả ảnh (Alt text)"
                [value]="image.altText"
                (input)="updateImageAltText(i, $any($event.target).value)"
              />
              <small class="image-name">{{ image.file.name }}</small>
              <small class="image-order">Thứ tự: {{ image.displayOrder }}</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="goBack()" [disabled]="isSubmitting">
          Hủy
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting">
          <fa-icon [icon]="faSave" *ngIf="!isSubmitting"></fa-icon>
          <span *ngIf="!isSubmitting">Thêm sản phẩm</span>
          <span *ngIf="isSubmitting">Đang xử lý...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Category Selection Modal -->
<div class="modal-overlay" *ngIf="showCategoryModal" (click)="closeCategoryModal()">
  <div class="modal-content category-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <fa-icon [icon]="faFolder"></fa-icon>
        Chọn danh mục
      </h3>
      <button class="btn-close" (click)="closeCategoryModal()">
        <fa-icon [icon]="faXmark"></fa-icon>
      </button>
    </div>

    <div class="modal-body">
      <div class="category-list">
        <div 
          *ngFor="let item of getFlatCategoryList(categories)" 
          class="category-item"
          [style.padding-left.px]="20 + (item.level * 20)"
          (click)="selectCategory(item.category)"
          [class.selected]="selectedCategory?.categoryId === item.category.categoryId"
        >
          <fa-icon [icon]="faCheck" class="check-icon" *ngIf="selectedCategory?.categoryId === item.category.categoryId"></fa-icon>
          <span class="category-name">{{ item.category.name }}</span>
        </div>
        <div *ngIf="categories.length === 0" class="no-data">
          Không có danh mục nào
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeCategoryModal()">Đóng</button>
    </div>
  </div>
</div>

<!-- Variant Modal -->
@if (showVariantModal) {
<div class="modal-overlay" (click)="closeVariantModal()">
  <div class="modal-content variant-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <fa-icon [icon]="faCubes"></fa-icon>
        {{ variantMode === 'add' ? 'Thêm phân loại' : 'Chỉnh sửa phân loại' }}
      </h3>
      <button class="btn-close" (click)="closeVariantModal()">
        <fa-icon [icon]="faXmark"></fa-icon>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-section">
        <h4 class="subsection-title">Thông tin cơ bản</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label>SKU phân loại <span class="required">*</span></label>
            <input
              type="text"
              [(ngModel)]="currentVariant.sku"
              class="form-control"
              placeholder="Nhập SKU phân loại (vd: SKU-001-RED)"
            />
          </div>

          <div class="form-group">
            <label>Tên phân loại</label>
            <input
              type="text"
              [(ngModel)]="currentVariant.name"
              class="form-control"
              placeholder="Nhập tên phân loại (vd: Màu đỏ - Size M)"
            />
          </div>
        </div>

        <div class="form-group">
          <label>Hình ảnh phân loại</label>
          <input
            type="file"
            id="variantImageInput"
            accept="image/*"
            (change)="onVariantImageSelected($event)"
            style="display: none;"
          />
          
          <!-- Upload Area or Preview -->
          <div *ngIf="!variantImagePreview" 
            class="variant-image-upload-area"
            [class.dragging]="isVariantDragging"
            (dragover)="onVariantDragOver($event)"
            (dragleave)="onVariantDragLeave($event)"
            (drop)="onVariantDrop($event)"
            (click)="triggerVariantImageInput()"
          >
            <div class="upload-content">
              <fa-icon [icon]="faImage" class="upload-icon"></fa-icon>
              <p class="upload-text">Kéo thả ảnh vào đây hoặc click để chọn</p>
              <p class="upload-hint">Hỗ trợ: JPG, PNG, GIF (Tối đa 5MB)</p>
            </div>
          </div>
          
          <!-- Image Preview -->
          <div *ngIf="variantImagePreview" class="variant-image-preview-container">
            <div class="variant-image-preview">
              <img [src]="variantImagePreview" alt="Variant preview" />
              <div class="image-overlay">
                <button 
                  type="button" 
                  class="btn-icon btn-change"
                  (click)="triggerVariantImageInput()"
                  title="Thay đổi ảnh"
                >
                  <fa-icon [icon]="faImage"></fa-icon>
                </button>
                <button 
                  type="button" 
                  class="btn-icon btn-delete"
                  (click)="removeVariantImage()"
                  title="Xóa ảnh"
                >
                  <fa-icon [icon]="faTrash"></fa-icon>
                </button>
              </div>
            </div>
          </div>
          
          <small class="form-hint">Để trống nếu sử dụng ảnh sản phẩm chính</small>
        </div>
      </div>

      <div class="form-section">
        <h4 class="subsection-title">Giá & Tồn kho</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label>Giá bán <span class="required">*</span></label>
            <input
              type="number"
              [(ngModel)]="currentVariant.price"
              class="form-control"
              min="0"
              step="1000"
              placeholder="0"
            />
          </div>

          <div class="form-group">
            <label>Giá giảm</label>
            <input
              type="number"
              [(ngModel)]="currentVariant.discountPrice"
              class="form-control"
              min="0"
              step="1000"
              placeholder="0"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Số lượng tồn kho <span class="required">*</span></label>
            <input
              type="number"
              [(ngModel)]="currentVariant.stockQuantity"
              class="form-control"
              min="0"
              placeholder="0"
            />
          </div>

          <div class="form-group">
            <label>Mức tồn tối thiểu <span class="required">*</span></label>
            <input
              type="number"
              [(ngModel)]="currentVariant.minStockLevel"
              class="form-control"
              min="0"
              placeholder="10"
            />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4 class="subsection-title">Thông tin vật lý</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label>Trọng lượng (kg)</label>
            <input
              type="number"
              [(ngModel)]="currentVariant.weight"
              class="form-control"
              min="0"
              step="0.01"
              placeholder="0.00"
            />
          </div>

          <div class="form-group">
            <label>Kích thước</label>
            <input
              type="text"
              [(ngModel)]="currentVariant.dimensions"
              class="form-control"
              placeholder="DxRxC (mm)"
            />
          </div>
        </div>

        <div class="form-group">
          <label>Trạng thái <span class="required">*</span></label>
          <select
            [(ngModel)]="currentVariant.status"
            class="form-control"
          >
            <option [value]="1">Hoạt động</option>
            <option [value]="2">Nháp</option>
            <option [value]="3">Đã lưu trữ</option>
          </select>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeVariantModal()">
        Hủy
      </button>
      <button type="button" class="btn btn-primary" (click)="saveVariant()">
        <fa-icon [icon]="faSave"></fa-icon>
        {{ variantMode === 'add' ? 'Thêm' : 'Cập nhật' }}
      </button>
    </div>
  </div>
</div>
}
