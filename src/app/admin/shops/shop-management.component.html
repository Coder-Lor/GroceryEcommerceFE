<div class="shop-management container-fluid py-4">
  <p-toast></p-toast>

  <div class="d-flex justify-content-between align-items-center mb-3 shop-header">
    <div>
      <h4 class="mb-1 fw-semibold">Quản lý shop</h4>
      <p class="text-muted small mb-0">Theo dõi và quản lý tất cả các shop trên hệ thống</p>
    </div>
    <div class="d-flex align-items-center gap-2 shop-search">
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input
          pInputText
          type="text"
          placeholder="Tìm theo tên hoặc slug..."
          [(ngModel)]="searchTerm"
          (keyup.enter)="onSearch()"
        />
      </span>
      <button
        pButton
        type="button"
        label="Tìm kiếm"
        icon="pi pi-search"
        class="p-button-primary"
        (click)="onSearch()"
        [disabled]="isLoading"
      ></button>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <!-- Trạng thái loading -->
      <div *ngIf="isLoading" class="text-center py-4">
        <p-progressSpinner styleClass="shop-spinner" strokeWidth="4"></p-progressSpinner>
        <p class="mt-3 mb-0 text-muted small">Đang tải dữ liệu...</p>
      </div>

      <!-- Không có dữ liệu -->
      <div *ngIf="!isLoading && shops.length === 0" class="text-center py-4 text-muted">
        Chưa có shop nào
      </div>

      <!-- Danh sách shop dạng card -->
      <div class="row g-3 shop-grid" *ngIf="!isLoading && shops.length > 0">
        <div class="col-12 col-sm-6 col-lg-4 col-xl-3" *ngFor="let shop of shops">
          <div class="shop-card card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center mb-3">
                <div class="shop-logo me-3">
                  <img
                    *ngIf="shop.logoUrl"
                    [src]="shop.logoUrl"
                    [alt]="shop.name"
                    class="shop-logo-img"
                  />
                  <div *ngIf="!shop.logoUrl" class="shop-logo-placeholder">
                    {{ (shop.name || 'S')[0] | uppercase }}
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h6 class="fw-semibold mb-1 text-truncate" [title]="shop.name">{{ shop.name }}</h6>
                  <p class="text-muted small mb-0 text-truncate">
                    Slug: {{ shop.slug || '-' }}
                  </p>
                </div>
                <p-tag
                  [value]="shop.status === 1 ? 'Hoạt động' : 'Ngưng'"
                  [severity]="shop.status === 1 ? 'success' : 'warn'"
                  class="ms-2"
                ></p-tag>
              </div>

              <div class="small text-muted mb-3">
                <div>Chủ shop: <span class="fw-semibold">{{ shop.ownerUserId || 'N/A' }}</span></div>
                <div>Ngày tạo: {{ shop.createdAt | date: 'dd/MM/yyyy' }}</div>
              </div>

              <div class="mt-auto d-flex justify-content-between gap-2">
                <button
                  pButton
                  type="button"
                  icon="pi pi-eye"
                  label="Chi tiết"
                  class="p-button-text p-button-sm"
                  (click)="viewShopDetail(shop)"
                ></button>
                <button
                  pButton
                  type="button"
                  [icon]="shop.status === 1 ? 'pi pi-ban' : 'pi pi-check-circle'"
                  [label]="shop.status === 1 ? 'Tắt' : 'Kích hoạt'"
                  class="p-button-outlined p-button-sm"
                  (click)="toggleStatus(shop)"
                  [disabled]="isLoading"
                ></button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Phân trang -->
      <div class="d-flex justify-content-between align-items-center pt-3 border-top mt-3" *ngIf="totalCount > 0">
        <small class="text-muted">
          {{ totalCount }} shop • Trang {{ currentPage }} /
          {{ Math.max(1, Math.ceil(totalCount / pageSize)) }}
        </small>
        <div class="d-flex align-items-center gap-2">
          <button
            pButton
            type="button"
            icon="pi pi-chevron-left"
            class="p-button-text p-button-sm"
            (click)="changePage(-1)"
            [disabled]="currentPage === 1"
          ></button>
          <span class="small px-2 rounded-pill bg-light border">
            {{ currentPage }}
          </span>
          <button
            pButton
            type="button"
            icon="pi pi-chevron-right"
            class="p-button-text p-button-sm"
            (click)="changePage(1)"
            [disabled]="currentPage >= Math.ceil(totalCount / pageSize)"
          ></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal xem chi tiết shop (PrimeNG Dialog) -->
  <p-dialog
    header="Chi tiết shop"
    [(visible)]="showDetail"
    [modal]="true"
    [style]="{ width: '600px', maxWidth: '95vw' }"
    [dismissableMask]="true"
    *ngIf="selectedShop"
    (onHide)="closeDetail()"
  >
    <ng-template pTemplate="content">
      <h5 class="fw-semibold mb-1">{{ selectedShop.name }}</h5>
      <p class="text-muted small mb-3">Slug: {{ selectedShop.slug || '-' }}</p>

      <div class="row small">
        <div class="col-md-6 mb-2">
          <div class="text-muted">Mã shop</div>
          <div class="fw-semibold">{{ selectedShop.shopId }}</div>
        </div>
        <div class="col-md-6 mb-2">
          <div class="text-muted">Chủ shop</div>
          <div class="fw-semibold">{{ selectedShop.ownerUserId || 'N/A' }}</div>
        </div>
        <div class="col-md-6 mb-2">
          <div class="text-muted">Trạng thái</div>
          <div>
            <p-tag
              [value]="selectedShop.status === 1 ? 'Hoạt động' : 'Ngưng'"
              [severity]="selectedShop.status === 1 ? 'success' : 'warn'"
            ></p-tag>
          </div>
        </div>
        <div class="col-md-6 mb-2">
          <div class="text-muted">Ngày tạo</div>
          <div class="fw-semibold">{{ selectedShop.createdAt | date: 'dd/MM/yyyy HH:mm' }}</div>
        </div>
      </div>

      <div class="mt-3 small" *ngIf="selectedShop.description">
        <div class="text-muted mb-1">Mô tả</div>
        <p class="mb-0">{{ selectedShop.description }}</p>
      </div>

      <div class="mt-3">
        <a
          pButton
          type="button"
          label="Mở trang shop (giao diện khách hàng)"
          icon="pi pi-external-link"
          class="p-button-text p-button-sm"
          [routerLink]="['/shop', selectedShop.shopId]"
          target="_blank"
        ></a>
      </div>
    </ng-template>
    <ng-template pTemplate="footer">
      <button pButton type="button" label="Đóng" class="p-button-text" (click)="closeDetail()"></button>
    </ng-template>
  </p-dialog>
</div>

