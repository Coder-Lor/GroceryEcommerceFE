<div class="product-page">
  <!-- Toast for notifications -->
  <p-toast></p-toast>

  <!-- Breadcrumb -->
  <div class="container mb-4">
    <!-- <app-breadcrumb></app-breadcrumb> -->
  </div>

  <!-- Loading State -->
  @if (isLoading) {
  <div class="container text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Đang tải...</span>
    </div>
    <p class="mt-3">Đang tải thông tin sản phẩm...</p>
  </div>
  }

  <!-- Product Not Found -->
  @else if (!product) {
  <div class="container text-center py-5">
    <i class="pi pi-exclamation-triangle" style="font-size: 3rem; color: #dc3545"></i>
    <h3 class="mt-3">Không tìm thấy sản phẩm</h3>
    <p class="text-muted">Sản phẩm bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
    <button class="btn btn-primary mt-3" routerLink="/home">Về trang chủ</button>
  </div>
  }

  <!-- Product Details -->
  @else {
  <div class="container product-details rounded-3 p-4 mb-5">
    <div class="row g-4">
      <!-- Left: Image Gallery -->
      <div class="col-lg-6 col-md-12">
        <div class="product-gallery">
          <p-galleria [value]="productImages" [(activeIndex)]="activeIndex" [responsiveOptions]="responsiveOptions"
            [containerStyle]="{ width: '100%', 'max-width': '100%' }" [numVisible]="5" [circular]="true"
            [showItemNavigators]="false" [showThumbnails]="productImages.length > 1" [showIndicators]="false"
            [showItemNavigatorsOnHover]="false" [showThumbnailNavigators]="true" [thumbnailsPosition]="'bottom'"
            [autoPlay]="false" [transitionInterval]="3000">
            <ng-template pTemplate="item" let-item>
              <div class="gallery-item">
                <p-image [src]="item.itemImageSrc" [alt]="item.alt" [preview]="true" [imageStyle]="{
                    width: '100%',
                    height: '480px',
                    'max-height': '480px',
                    'object-fit': 'cover'
                  }" imageClass="gallery-main-image" />
              </div>
            </ng-template>
            <ng-template pTemplate="thumbnail" let-item>
              <div class="gallery-thumbnail">
                <img [src]="item.thumbnailImageSrc" [alt]="item.alt" [title]="item.title" class="thumbnail-image" />
              </div>
            </ng-template>
          </p-galleria>
        </div>
      </div>

      <!-- Right: Info -->
      <div class="col-lg-6 col-md-12">
        <div class="product-info">
          <h1 class="product-name d-flex align-items-center gap-2">
            {{ product.name }}
            @if (shopId) {
            <button class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-2" (click)="navigateToShop()">
              <i class="pi pi-shop"></i>
              <span>{{ shopName }}</span>
            </button>
            }
          </h1>

          <!-- Selected Variant Info -->
          @if (selectedVariantId && getSelectedVariant()) {
          <div class="selected-variant-info mb-3 p-2 bg-light rounded d-flex align-items-center gap-2">
            <i class="pi pi-check-circle text-success"></i>
            <span class="text-muted small">Đã chọn: <strong>{{ getSelectedVariant()?.name }}</strong></span>
          </div>
          }

          <!-- Rating -->
          <div class="rating-section d-flex align-items-center gap-3 mb-4">
            <img src="/icons/Star.svg" alt="Rating" width="24" height="24" />
            <div class="rating-text">
              <strong>{{ product.averageRating || 0 | number : '1.1-1' }}</strong>
              <span class="text-muted">({{ product.reviewCount || 0 }} đánh giá)</span>
            </div>
          </div>

          <!-- Variant Section -->
          <div class="variant-section mb-4">
            <h5 class="variant-title mb-3"><i class="pi pi-box me-2"></i>Phân loại</h5>

            <div class="variant-options d-flex gap-3 mt-3 flex-wrap">
              @if (product.variants.length > 0){
              @for (item of product.variants; track item.productVariantId) {
              <span class="variant-option" [class.active]="selectedVariantId === item.productVariantId" role="button"
                tabindex="0" (click)="selectVariant(item.productVariantId!)"
                (keydown.enter)="selectVariant(item.productVariantId!)"
                (keydown.space)="selectVariant(item.productVariantId!)">
                <span class="variant-text">{{ item.name }}</span>
              </span>
              }
              } @else {
              <span class="text-muted">Không có phân loại.</span>
              }
            </div>
          </div>

          <!-- Purchase Section -->
          <div class="purchase-section">
            <div class="price-container mb-3">
              <div class="price-row d-flex align-items-center gap-2">
                <span class="current-price">
                  {{ getDisplayPrice() | currency : 'VND' : 'symbol' : '1.0-0' }}
                </span>
                @if (getDiscountPrice() && getOriginalPrice() > getDiscountPrice()!) {
                <span class="discount-badge">
                  <span class="discount-text">
                    -{{
                    ((getOriginalPrice() - getDiscountPrice()!) / getOriginalPrice()) * 100
                    | number : '1.0-0'
                    }}%
                  </span>
                </span>
                }
              </div>
              @if (getDiscountPrice() && getOriginalPrice() > getDiscountPrice()!) {
              <div class="original-price">
                {{ getOriginalPrice() | currency : 'VND' : 'symbol' : '1.0-0' }}
              </div>
              }
            </div>

            <div class="quantity-selector mb-3">
              <label class="form-label fw-semibold">Số lượng:</label>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-secondary" (click)="quantity = quantity > 1 ? quantity - 1 : 1"
                  type="button" [disabled]="getStockQuantity() <= 0">
                  <i class="pi pi-minus"></i>
                </button>
                <input type="number" class="form-control text-center" style="max-width: 80px" [(ngModel)]="quantity"
                  min="1" [max]="getStockQuantity()" [disabled]="getStockQuantity() <= 0" />
                <button class="btn btn-sm btn-outline-secondary" (click)="quantity = quantity + 1" type="button"
                  [disabled]="getStockQuantity() <= 0 || quantity >= getStockQuantity()">
                  <i class="pi pi-plus"></i>
                </button>
              </div>
              @if (getStockQuantity() > 0) {
              <small class="text-muted mt-2 d-block">Còn {{ getStockQuantity() }} sản phẩm</small>
              }
            </div>

            <div class="action-buttons d-flex gap-3 flex-wrap">
              <button class="btn btn-warning text-dark fw-semibold px-4 rounded btn-checkout flex-grow-1"
                (click)="navigationToCheckout()" [disabled]="getStockQuantity() <= 0">
                <i class="pi pi-credit-card me-2"></i>Mua ngay
              </button>
              <button class="btn border rounded add-to-cart-button flex-grow-1" (click)="addToCart()"
                [disabled]="getStockQuantity() <= 0">
                <i class="pi pi-shopping-cart me-2"></i>Thêm vào giỏ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs Section -->
  <div class="container product-tabs mt-5">
    <p-tabs value="0">
      <p-tablist>
        <p-tab value="0">Mô tả</p-tab>
        <p-tab value="2">Đánh giá</p-tab>
        <p-tab value="3">Sản phẩm tương tự</p-tab>
      </p-tablist>
      <p-tabpanels>
        <p-tabpanel value="0">
          <div class="product-description">
            <h5 class="mb-3">Mô tả sản phẩm</h5>
            <div [innerHTML]="product.description || 'Chưa có mô tả cho sản phẩm này.'"></div>

            @if (product.shortDescription) {
            <div class="mt-3">
              <h6>Tóm tắt:</h6>
              <p class="text-muted">{{ product.shortDescription }}</p>
            </div>
            }

            <div class="product-meta mt-4">
              <p><strong>Danh mục:</strong> {{ product.categoryName || 'Chưa phân loại' }}</p>
              @if (product.brandName) {
              <p><strong>Thương hiệu:</strong> {{ product.brandName }}</p>
              }
              <p><strong>SKU:</strong> {{ product.sku }}</p>
              <p>
                <strong>Trạng thái:</strong>
                @if (product.stockQuantity > 0) {
                <span class="badge bg-success">Còn hàng ({{ product.stockQuantity }} sản phẩm)</span>
                } @else {
                <span class="badge bg-danger">Hết hàng</span>
                }
              </p>
            </div>
          </div>
        </p-tabpanel>
        <p-tabpanel value="2">
          <div class="reviews-section mt-2">
            <div class="reviews-title d-flex justify-content-between align-items-center">
              <h4 class="mb-0 fw-semibold text-dark">Những gì khách hàng khác đang bình luận...</h4>
              <button class="filter d-flex align-items-center gap-2">
                <i class="pi pi-filter"></i> Filter
              </button>
            </div>

            <div class="reviews-list mt-4">
              <!-- Review 1 -->
              <div class="review-card pb-4 mb-4 border-bottom">
                <div class="reviewer d-flex gap-3 align-items-start">
                  <img class="reviewer-avatar rounded-circle" src="ellipse-610.png" alt="avatar" />
                  <div class="reviewer-info flex-grow-1">
                    <div class="review-header mb-2">
                      <div class="d-flex flex-column flex-sm-row align-items-sm-center justify-content-between">
                        <span class="reviewer-name fw-semibold text-dark">Mariya Lykra</span>
                        <div class="stars d-flex">
                          <img src="icons/Star.svg" alt="" />
                          <img src="icons/Star.svg" alt="" />
                          <img src="icons/Star.svg" alt="" />
                          <img src="icons/Star.svg" alt="" />
                          <img src="icons/Star-empty.svg" alt="" />
                        </div>
                      </div>
                    </div>
                    <p class="review-text mb-0">
                      Lorem Ipsum is simply dummy text of the printing and typesetting industry.
                      Lorem Ipsum has been the industry's standard dummy text ever since the
                      1500s...
                    </p>
                  </div>
                </div>
              </div>

              <!-- Review 2 -->
              <div class="review-card pb-4 mb-4 border-bottom">
                <div class="reviewer d-flex gap-3 align-items-start">
                  <img class="reviewer-avatar rounded-circle" src="ellipse-611.png" alt="avatar" />
                  <div class="reviewer-info flex-grow-1">
                    <div class="review-header mb-2">
                      <div class="d-flex flex-column flex-sm-row align-items-sm-center justify-content-between">
                        <span class="reviewer-name fw-semibold text-dark">Moris Willson</span>
                        <div class="stars d-flex">
                          <img src="icons/Star.svg" alt="" />
                          <img src="icons/Star.svg" alt="" />
                          <img src="icons/Star-half.svg" alt="" />
                          <img src="icons/Star-empty.svg" alt="" />
                          <img src="icons/Star-empty.svg" alt="" />
                        </div>
                      </div>
                    </div>
                    <p class="review-text mb-0">
                      Lorem Ipsum has been the industry's standard dummy text ever since the 1500s,
                      when an unknown printer took a galley of type and scrambled it to make a type
                      specimen.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </p-tabpanel>
        <p-tabpanel value="3">
          <div class="related-products-section">

            @if (isLoadingRelated) {
            <div class="text-center py-4">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Đang tải...</span>
              </div>
              <p class="mt-2 text-muted small">Đang tải sản phẩm tương tự...</p>
            </div>
            } @else if (relatedProducts.length === 0) {
            <div class="text-center py-4">
              <i class="pi pi-box text-muted" style="font-size: 2rem"></i>
              <p class="mt-2 text-muted">Không có sản phẩm tương tự</p>
            </div>
            } @else {
            <div class="row g-3">
              @for (relatedProduct of relatedProducts; track relatedProduct.productId) {
              <div class="col-6 col-md-4 col-lg-3">
                <product-card [product]="relatedProduct" [layout]="'grid'" [getSeverity]="getSeverity">
                </product-card>
              </div>
              }
            </div>
            }
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>
  }
</div>