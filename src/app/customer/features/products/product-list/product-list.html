<div class="product-page container-fluid">
  <div class="row">
    <!-- LEFT SIDEBAR -->
    <aside class="col-lg-2 col-md-4 filter-sidebar">
      <div class="filter-section category">
        <h6 class="filter-title"><i class="pi pi-list mr-2"></i> Tất Cả Danh Mục</h6>

        <!-- Loading skeleton for categories -->
        @if (loadingCategories) {
        <ul class="filter-list">
          @for (item of [1,2,3,4,5]; track $index) {
          <li>
            <p-skeleton width="100%" height="1.2rem" styleClass="mb-2"></p-skeleton>
          </li>
          }
        </ul>
        }
        @else {
        <ul class="filter-list">
          <!-- Tất cả sản phẩm -->
          <li class="category-item" [class.active]="!categoryId" (click)="filterByCategory(undefined)">
            <span class="category-name">Tất cả sản phẩm</span>
          </li>

          <!-- Parent categories with sub-categories (Level 1) -->
          @for (category of categories; track category.categoryId) {
          <li class="category-item parent" [class.active]="isCategoryActive(category.categoryId)"
            [class.expanded]="isCategoryExpanded(category.categoryId!)">
            <div class="category-header">
              <span class="category-name" (click)="filterByCategory(category.categoryId)">
                {{ category.name }}
              </span>
              @if (category.subCategories && category.subCategories.length > 0) {
              <i class="pi toggle-icon" [class.pi-chevron-down]="!isCategoryExpanded(category.categoryId!)"
                [class.pi-chevron-up]="isCategoryExpanded(category.categoryId!)"
                (click)="toggleCategoryExpand(category.categoryId!)"></i>
              }
            </div>

            <!-- Sub categories (Level 2) -->
            @if (category.subCategories && category.subCategories.length > 0 &&
            isCategoryExpanded(category.categoryId!)) {
            <ul class="sub-category-list">
              @for (subCategory of category.subCategories; track subCategory.categoryId) {
              <li class="category-item sub" [class.active]="isCategoryActive(subCategory.categoryId)"
                [class.expanded]="isCategoryExpanded(subCategory.categoryId!)">
                <div class="category-header">
                  <span class="category-name" (click)="filterByCategory(subCategory.categoryId)">
                    {{ subCategory.name }}
                  </span>
                  @if (subCategory.subCategories && subCategory.subCategories.length > 0) {
                  <i class="pi toggle-icon" [class.pi-chevron-down]="!isCategoryExpanded(subCategory.categoryId!)"
                    [class.pi-chevron-up]="isCategoryExpanded(subCategory.categoryId!)"
                    (click)="toggleCategoryExpand(subCategory.categoryId!)"></i>
                  }
                </div>

                <!-- Sub-sub categories (Level 3) -->
                @if (subCategory.subCategories && subCategory.subCategories.length > 0 &&
                isCategoryExpanded(subCategory.categoryId!)) {
                <ul class="sub-sub-category-list">
                  @for (subSubCategory of subCategory.subCategories; track subSubCategory.categoryId) {
                  <li class="category-item sub-sub" [class.active]="isCategoryActive(subSubCategory.categoryId)"
                    (click)="filterByCategory(subSubCategory.categoryId)">
                    {{ subSubCategory.name }}
                  </li>
                  }
                </ul>
                }
              </li>
              }
            </ul>
            }
          </li>
          }
        </ul>
        }
      </div>
    </aside>

    <!-- RIGHT PRODUCT LIST -->
    <section class="col-lg-9 col-md-8">
      <div class="product-list container-fluid">
        <div class="mb-3" *ngIf="keyword">
          Kết quả cho: "<strong>{{ keyword }}</strong>"
        </div>
        <p-dataview #dv [value]="products" [layout]="layout" [emptyMessage]="' '">
          <!-- Header -->
          <ng-template #header>
            <div class="d-flex" style="gap: 10px">
              <p style="color: #111; margin-top: 6px">Sắp xếp bởi</p>
              <p-button label="Phổ biến" severity="secondary" />
              <p-button label="Mới nhất" severity="secondary" />
              <p-button label="Bán chạy" severity="secondary" />
              <p-select [options]="sortByPrice" [(ngModel)]="selectField" optionLabel="title" placeholder="Giá: "
                class="w-full md:w-56" />
            </div>
          </ng-template>

          <!-- GRID layout -->
          <ng-template #grid let-items>
            <!-- Loading Skeleton -->
            @if (loading) {
            <div class="row g-4">
              @for (item of [1,2,3,4,5,6,7,8]; track $index) {
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="skeleton-card">
                  <p-skeleton width="100%" height="200px" styleClass="skeleton-image"></p-skeleton>
                  <div class="skeleton-content">
                    <p-skeleton width="100%" height="1rem" styleClass="mb-2"></p-skeleton>
                    <p-skeleton width="70%" height="1rem" styleClass="mb-2"></p-skeleton>
                    <p-skeleton width="40%" height="1.5rem"></p-skeleton>
                  </div>
                </div>
              </div>
              }
            </div>
            }
            <!-- Empty State -->
            @else {
            @if (products.length === 0) {
            <div class="empty-state">
              <div class="empty-state-content">
                <i class="pi pi-search empty-icon"></i>
                <h3 class="empty-title">Không tìm thấy sản phẩm</h3>
                <p class="empty-description">
                  @if (keyword) {
                  Không có sản phẩm nào phù hợp với từ khóa "<strong>{{ keyword }}</strong>"
                  } @else {
                  Danh mục này hiện chưa có sản phẩm nào.
                  }
                </p>
                <p class="empty-suggestion">Vui lòng thử tìm kiếm với từ khóa khác hoặc khám phá các danh mục khác.</p>
              </div>
            </div>
            }
            <!-- Products Grid -->
            @else {
            <div class="row g-4">
              @for (item of products; track $index) {
              <div class="col-12 col-sm-6 col-lg-3">
                <product-card [product]="item" [layout]="'grid'" [getSeverity]="getSeverity.bind(this)"></product-card>
              </div>
              }
            </div>
            }
            }
          </ng-template>
        </p-dataview>
      </div>
    </section>
  </div>
  <div class="row">
    <div class="d-flex justify-content-center mt-4">
      <p-paginator (onPageChange)="onPageChange($event)" [first]="first" [rows]="rows" [totalRecords]="totalRecords" />
    </div>
  </div>
</div>