@defer () {
<!-- üîî Announcement Topbar -->
<div class="topbar-announcement" [class.hide]="!showTopbar">
  <div class="marquee">
    <div class="marquee-track">
      <span>
        üéâ T∆∞ng b·ª´ng khai tr∆∞∆°ng ‚Äì Gi·∫£m gi√° l√™n ƒë·∫øn 50% to√†n b·ªô s·∫£n ph·∫©m! ‚Äî Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn ƒë∆°n
        t·ª´ 199k üéâ
      </span>
      <span>üéÅ Qu√† t·∫∑ng b·∫•t ng·ªù cho 100 kh√°ch h√†ng ƒë·∫ßu ti√™n gh√© thƒÉm v√† mua s·∫Øm!</span>
      <span>üåü C∆° h·ªôi duy nh·∫•t trong nƒÉm ƒë·ªÉ s·ªü h·ªØu nh·ªØng s·∫£n ph·∫©m y√™u th√≠ch v·ªõi m·ª©c gi√° kh√¥ng th·ªÉ t·ªët
        h∆°n!</span>

      <span>
        üéâ T∆∞ng b·ª´ng khai tr∆∞∆°ng ‚Äì Gi·∫£m gi√° l√™n ƒë·∫øn 50% to√†n b·ªô s·∫£n ph·∫©m! ‚Äî Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn ƒë∆°n
        t·ª´ 199k üéâ
      </span>
      <span>üéÅ Qu√† t·∫∑ng b·∫•t ng·ªù cho 100 kh√°ch h√†ng ƒë·∫ßu ti√™n gh√© thƒÉm v√† mua s·∫Øm!</span>
      <span>üåü C∆° h·ªôi duy nh·∫•t trong nƒÉm ƒë·ªÉ s·ªü h·ªØu nh·ªØng s·∫£n ph·∫©m y√™u th√≠ch v·ªõi m·ª©c gi√° kh√¥ng th·ªÉ t·ªët
        h∆°n!</span>
    </div>
    <!-- fade 2 b√™n -->
    <div class="fade-left"></div>
    <div class="fade-right"></div>
  </div>
</div>
<div class="header-container fixed-top" [class.with-topbar]="showTopbar" [class.no-topbar]="!showTopbar">
  <div class="header-bar container-fluid">
    <div class="header-content d-flex justify-content-between align-items-center">
      <!-- Left Section -->
      <div class="header-left d-flex align-items-center">
        <!-- mobile toggle -->
        <div class="mobile-menu-toggle d-md-none me-2" (click)="toggleSidebar()">
          <img src="/icons/icon-catelogy.svg" alt="Menu" />
        </div>

        <!-- brand -->
        <div class="brand-logo d-flex align-items-center me-3" (click)="backToHomePage()">
          <img class="logo-icon" src="/icons/Icon.svg" />
          <div class="brand-name">grocerymart</div>
        </div>
      </div>

      <!-- Center Section: Mega Menu -->
      <!-- <div class="mega-menu-section d-none d-md-flex">
        <p-megaMenu *ngIf="categoryMenuItems.length > 0" [model]="categoryMenuItems"
          styleClass="custom-megamenu"></p-megaMenu>
      </div> -->

      <!-- Right Section: Search -->
      <div class="search-right d-none d-md-flex">
        <div class="search-box d-flex align-items-center text-body">
          <input #queryInput class="search-input" type="text" placeholder="T√¨m s·∫£n ph·∫©m..."
            (keyup.enter)="onSearch(queryInput.value)" />
          <button class="search-btn" (click)="onSearch(queryInput.value)">
            <i class="pi pi-search"></i>
          </button>
        </div>
      </div>

      <!-- AI Chat Button -->
      <div class="ai-chat-section d-none d-md-flex ms-3">
        <app-ai-chat></app-ai-chat>
      </div>

      <!-- Far Right Section: Cart & User -->
      <div class="header-right d-flex align-items-center">
        <!-- Cart & wishlist -->
        <div class="cart-wishlist me-3">
          <div class="cart-wishlist-content d-flex align-items-center">
            <div class="cart-section" (mouseenter)="onCartMouseEnter()" (mouseleave)="onCartMouseLeave()">
              <div class="cart-icon-wrapper" (click)="toggleUtilPanel()" style="cursor: pointer">
                <span class="cart-icon">
                  <i class="pi pi-shopping-cart"></i>
                </span>
                <span class="cart-badge">{{ (cartCount$ | async) || 0 }}</span>
              </div>

              @if (isShowMiniCart) {
              <div class="mini-cart-popover">
                @if ((miniItems$ | async)?.length ?? 0; as hasItems) {
                <div class="mini-cart-items">
                  @for (item of (miniItems$ | async) | slice:0:3; track item.cartItemId) {
                  <div class="mini-item">
                    <img [src]="item.imageUrl | proxyImage" [alt]="item.productName" />
                    <div class="mini-item-info">
                      <div class="mini-item-name">{{ item.productName }}</div>
                      <div class="mini-item-meta">
                        {{ item.quantity }} x {{ item.unitPrice | number : '1.0-0' }}‚Ç´
                      </div>
                    </div>
                  </div>
                  }
                </div>
                <div class="mini-cart-footer">
                  <button class="view-cart-btn" (click)="goToCart($event)">Xem gi·ªè h√†ng</button>
                </div>
                } @else {
                <div class="mini-cart-empty">
                  <p>Gi·ªè h√†ng c·ªßa b·∫°n ch∆∞a c√≥ g√¨!</p>
                </div>
                }
              </div>
              }
            </div>
          </div>
        </div>

        <!-- User / Login -->
        @if (isLoggedIn$ | async; as isLoggedIn) {
        <div class="user-menu-wrapper" #userMenu>
          <div class="user-avatar-container d-flex align-items-center" (click)="toggleUserMenu($event)">
            <div class="user-avatar me-2">
              <i class="pi pi-user"></i>
              <span style="margin-left: 5px">{{ (user$ | async)?.username }}</span>
            </div>
            <i class="pi pi-angle-down ms-1"></i>
          </div>

          @if(isOpen) {
          <div class="user-dropdown">
            <ul>
              <li (click)="redirectToProfile()">
                <i class="pi pi-id-card"></i> Qu·∫£n l√Ω h·ªì s∆°
              </li>
              @if(hasShop) {
              <li (click)="goToMyShop()">
                <i class="pi pi-shop"></i> Qu·∫£n l√Ω shop {{ myShopName ? '(' + myShopName + ')' : '' }}
              </li>
              } @else {
              <li (click)="goToRegisterShop()">
                <i class="pi pi-plus-circle"></i> ƒêƒÉng k√Ω l√†m nh√† b√°n
              </li>
              }
              @if((user$ | async)?.role === 'Admin') {
              <li (click)="redirectToAdmin()">
                <i style="font-size: 14px" class="pi pi-cog"></i> Trang qu·∫£n tr·ªã
              </li>
              }
              <li style="align-items: center" (click)="onLogout()">
                <i style="font-size: 14px" class="pi pi-sign-out"></i> ƒêƒÉng xu·∫•t
              </li>
            </ul>
          </div>
          }
        </div>

        } @else {
        <div class="user-avatar-container d-flex align-items-center" routerLink="/login" style="cursor: pointer">
          <div class="user-avatar me-2">
            <i class="pi pi-user"></i>
          </div>
          <a class="text-decoration-none">
            Login <i class="pi pi-sign-in"></i>
          </a>
        </div>
        }
      </div>
    </div>
  </div>
</div>

<!-- sidebar mobile -->
<div class="overlay" [ngClass]="{ open: isShowSidebar }" (click)="toggleSidebar()">
  <div class="sidebar-menu" [ngClass]="{ 'active-menu': isShowSidebar }" (click)="$event.stopPropagation()">
    <button class="back-btn" (click)="toggleSidebar()">
      <img src="icons/arrow-left.svg" alt="Back" />
    </button>

    <!-- Card -->
    <div class="menu-item">
      <div class="menu-item-left">
        <img class="icon" src="icons/buy.svg" alt="Cart" />
        <span class="menu-label">Cart</span>
      </div>
      <span class="menu-count">3</span>
    </div>

    <!-- Favorite -->
    <div class="menu-item">
      <div class="menu-item-left">
        <img class="icon" src="icons/heart.svg" alt="Favorite" />
        <span class="menu-label">Favorite</span>
      </div>
      <span class="menu-count">3</span>
    </div>

    <!-- utility panel component stays the same -->
    <app-utility-panel [showCart]="isShowPanel" [showSearch]="isShowSearchBox" (closeCartPanel)="toggleUtilPanel()"
      (closeSearchPanel)="toggleSearchBox()"></app-utility-panel>
  </div>
</div>

}