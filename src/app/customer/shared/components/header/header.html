<!-- ğŸ”” Announcement Topbar -->
<div class="topbar-announcement" *ngIf="showTopbar">
  <div class="marquee">
    <div class="marquee-track">
      <span>
        ğŸ‰ TÆ°ng bá»«ng khai trÆ°Æ¡ng â€“ Giáº£m giÃ¡ lÃªn Ä‘áº¿n 50% toÃ n bá»™ sáº£n pháº©m! â€” Miá»…n phÃ­ váº­n chuyá»ƒn Ä‘Æ¡n
        tá»« 199k ğŸ‰
      </span>
      <span>ğŸ QuÃ  táº·ng báº¥t ngá» cho 100 khÃ¡ch hÃ ng Ä‘áº§u tiÃªn ghÃ© thÄƒm vÃ  mua sáº¯m!</span>
      <span
        >ğŸŒŸ CÆ¡ há»™i duy nháº¥t trong nÄƒm Ä‘á»ƒ sá»Ÿ há»¯u nhá»¯ng sáº£n pháº©m yÃªu thÃ­ch vá»›i má»©c giÃ¡ khÃ´ng thá»ƒ tá»‘t
        hÆ¡n!</span
      >

      <span>
        ğŸ‰ TÆ°ng bá»«ng khai trÆ°Æ¡ng â€“ Giáº£m giÃ¡ lÃªn Ä‘áº¿n 50% toÃ n bá»™ sáº£n pháº©m! â€” Miá»…n phÃ­ váº­n chuyá»ƒn Ä‘Æ¡n
        tá»« 199k ğŸ‰
      </span>
      <span>ğŸ QuÃ  táº·ng báº¥t ngá» cho 100 khÃ¡ch hÃ ng Ä‘áº§u tiÃªn ghÃ© thÄƒm vÃ  mua sáº¯m!</span>
      <span
        >ğŸŒŸ CÆ¡ há»™i duy nháº¥t trong nÄƒm Ä‘á»ƒ sá»Ÿ há»¯u nhá»¯ng sáº£n pháº©m yÃªu thÃ­ch vá»›i má»©c giÃ¡ khÃ´ng thá»ƒ tá»‘t
        hÆ¡n!</span
      >
    </div>
    <!-- fade 2 bÃªn -->
    <div class="fade-left"></div>
    <div class="fade-right"></div>
  </div>
</div>
<div
  class="header-container fixed-top"
  [class.with-topbar]="showTopbar"
  [class.no-topbar]="!showTopbar"
>
  <div class="header-bar container-fluid">
    <div class="header-content d-flex justify-content-between align-items-center">
      <!-- Left Section -->
      <div class="header-left d-flex align-items-center">
        <!-- mobile toggle -->
        <div class="mobile-menu-toggle d-md-none me-2" (click)="toggleSidebar()">
          <img src="/icons/icon-catelogy.svg" alt="Menu" />
        </div>

        <!-- brand -->
        <div class="brand-logo d-flex align-items-center me-3" (click)="backToHomePage()">
          <img class="logo-icon" src="/icons/Icon.svg" />
          <div class="brand-name">grocerymart</div>
        </div>
      </div>

      <!-- Center Section: Mega Menu -->
      <div class="mega-menu-section d-none d-md-flex">
        <p-megaMenu *ngIf="categoryMenuItems.length > 0" [model]="categoryMenuItems" styleClass="custom-megamenu"></p-megaMenu>
        <p-megaMenu *ngIf="megaMenuItems.length > 0" [model]="megaMenuItems" styleClass="custom-megamenu"></p-megaMenu>
      </div>

      <!-- Right Section: Search -->
      <div class="search-right d-none d-md-flex">
        <div class="search-box d-flex align-items-center text-body">
          <input
            #queryInput
            class="search-input"
            type="text"
            placeholder="TÃ¬m sáº£n pháº©m..."
            (keyup.enter)="onSearch(queryInput.value)"
          />
          <button class="search-btn" (click)="onSearch(queryInput.value)">
            <i class="pi pi-search"></i>
          </button>
        </div>
      </div>

      <!-- Far Right Section: Cart & User -->
      <div class="header-right d-flex align-items-center">
        <!-- Cart & wishlist -->
        <div class="cart-wishlist me-3">
          <div class="cart-wishlist-content d-flex align-items-center">
            <div
              class="cart-section"
              (mouseenter)="onCartMouseEnter()"
              (mouseleave)="onCartMouseLeave()"
            >
              <div class="cart-icon-wrapper" (click)="toggleUtilPanel()" style="cursor: pointer">
                <span class="cart-icon">
                  <i class="pi pi-shopping-cart"></i>
                </span>
                <span class="cart-badge">{{ (cartCount$ | async) || 0 }}</span>
              </div>

              @if (isShowMiniCart) {
              <div class="mini-cart-popover">
                @if ((miniItems$ | async)?.length ?? 0; as hasItems) {
                <div class="mini-cart-items">
                  @for (item of (miniItems$ | async) | slice:0:3; track item.cartItemId) {
                  <div class="mini-item">
                    <img [src]="item.imageUrl" [alt]="item.productName" />
                    <div class="mini-item-info">
                      <div class="mini-item-name">{{ item.productName }}</div>
                      <div class="mini-item-meta">
                        {{ item.quantity }} x {{ item.unitPrice | number : '1.0-0' }}â‚«
                      </div>
                    </div>
                  </div>
                  }
                </div>
                <div class="mini-cart-footer">
                  <button class="view-cart-btn" (click)="goToCart($event)">Xem giá» hÃ ng</button>
                </div>
                } @else {
                <div class="mini-cart-empty">
                  <p>Giá» hÃ ng trá»‘ng</p>
                </div>
                }
              </div>
              }
            </div>
          </div>
        </div>

        <!-- User / Login -->
        @if (isLoggedIn$ | async; as isLoggedIn) {
        <div class="user-menu-wrapper" #userMenu>
          <div
            class="user-avatar-container d-flex align-items-center"
            (click)="toggleUserMenu($event)"
          >
            <div class="user-avatar me-2">
              <i class="pi pi-user"></i>
              <span style="margin-left: 5px">{{ (user$ | async)?.username }}</span>
            </div>
            <i class="pi pi-angle-down ms-1"></i>
          </div>

          @if(isOpen) {
          <div class="user-dropdown">
            <ul>
              <li (click)="redirectToProfile()">Quáº£n lÃ½ há»“ sÆ¡</li>
              <li>ÄÆ¡n mua</li>
              <li style="align-items: center" (click)="onLogout()">
                <i style="font-size: 14px" class="pi pi-sign-out"></i> ÄÄƒng Xuáº¥t
              </li>
            </ul>
          </div>
          }
        </div>

        } @else {
        <div class="user-avatar-container d-flex align-items-center" routerLink="/login" style="cursor: pointer">
          <div class="user-avatar me-2">
            <i class="pi pi-user"></i>
          </div>
          <a class="text-decoration-none">
            Login <i class="pi pi-sign-in"></i>
          </a>
        </div>
        }
      </div>
    </div>
  </div>
</div>

<!-- sidebar mobile -->
<div class="overlay" [ngClass]="{ open: isShowSidebar }" (click)="toggleSidebar()">
  <div
    class="sidebar-menu"
    [ngClass]="{ 'active-menu': isShowSidebar }"
    (click)="$event.stopPropagation()"
  >
    <button class="back-btn" (click)="toggleSidebar()">
      <img src="icons/arrow-left.svg" alt="Back" />
    </button>

    <!-- Card -->
    <div class="menu-item">
      <div class="menu-item-left">
        <img class="icon" src="icons/buy.svg" alt="Cart" />
        <span class="menu-label">Cart</span>
      </div>
      <span class="menu-count">3</span>
    </div>

    <!-- Favorite -->
    <div class="menu-item">
      <div class="menu-item-left">
        <img class="icon" src="icons/heart.svg" alt="Favorite" />
        <span class="menu-label">Favorite</span>
      </div>
      <span class="menu-count">3</span>
    </div>

    <!-- utility panel component stays the same -->
    <app-utility-panel
      [showCart]="isShowPanel"
      [showSearch]="isShowSearchBox"
      (closeCartPanel)="toggleUtilPanel()"
      (closeSearchPanel)="toggleSearchBox()"
    ></app-utility-panel>
  </div>
</div>
